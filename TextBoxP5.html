<html>

<head>
    <title>GlyphBox2d-Test</title>
    <script type="text/javascript" src="lib/path-utils.js"></script>
    <script type="text/javascript" src="lib/p5.js"></script>
    <script type="text/javascript">

    var font, txt = "p5%js", x = 200, y = 200, fontSize = 100;

    function preload()
    {
        font = loadFont("fonts/SourceSansPro.otf");
    }

    function setup()
    {
        createCanvas(600, 400);
        drawX();
    }

    function drawX()
    {
        background(240);
        stroke(0);
        fill(0,32);
        var bbox = drawGlyphs(font, txt, x, y, fontSize);
        rect(bbox.x, bbox.y+100, bbox.w, bbox.h);
    }

    function mousePressed()
    {
        pointInRect(mouseX, mouseY);
    }

    function drawGlyphs(font, text, x, y, fontSize) {

        var glyphs = font._getGlyphs(text), xoff = x;

        var glyphBounds = [];
        // loop over each glyph and get its path(s)
        for (var i = 0; i < glyphs.length; i++) {

            var bbox = drawGlyph(glyphs[i], xoff, y, fontSize);
            console.log(glyphs[i].name.toUpperCase());
            rect(bbox.x, bbox.y, bbox.w, bbox.h);
            xoff += glyphs[i].advanceWidth * font._scale(fontSize);
            glyphBounds.push(bbox);
        }

        return joinBounds(glyphBounds);
    }

    function drawGlyph(glyph, x, y, fontSize) {

        var gpath = glyph.getPath(x, y, fontSize),
            paths = splitPaths(gpath.toPathData());

        //console.log('draw: '+glyph.name.toUpperCase()+', paths='+paths.length);

        // draw each path as a poly or a hole

        var bboxes = [];

        beginShape();
        for (var j = 0; j < paths.length; j++) {

            //console.log('  '+j+')'+paths[j]);
            var pfp = pointsFromPath(paths[j], false);
            drawPoly(pfp.points, paths.length, j);
            bboxes.push(pfp.bounds);
        }
        endShape(CLOSE);

        return joinBounds(bboxes);
    }

    function joinBounds(bbs) {

        var minX = minY = Number.MAX_VALUE;
        var maxX = maxY = -Number.MAX_VALUE;

        for (var i = 0; i < bbs.length; i ++) {

            if (bbs[i].x < minX) minX = bbs[i].x;
            if (bbs[i].x2 > maxX) maxX = bbs[i].x2;

            if (bbs[i].y < minY) minY = bbs[i].y;
            if (bbs[i].y2 > maxY) maxY = bbs[i].y2;
        }

        return {
            x: minX,
            y: minY,
            w: maxX-minX,
            h: maxY-minY,
            x2: maxX,
            y2: maxY
        }
    }

    // NEXT: need to determine what is a hole and what isn't
    // if not-a-hole, draw a new shape
    // if a hole, continue the last-shape, and draw as a contour
    function drawPoly(pts, num, k) // yuck, use drawContour/drawPoly instead?
    {
        //console.log('drawPoly: ',k);

        var isContour = k % 2 == 1;

        if (num>4) {
            if (k == 2)
            isContour = true;
            if (k>2) {

                return;
            }
        }

        //console.log(k,isContour);
        isContour && beginContour();

        for (var i = 0; i < pts.length; i++)
            vertex(pts[i].x, pts[i].y);

        isContour && endContour();

        //drawPoints(pts);
    }

    function splitPaths(path) {

        var paths = path.split('M');
        paths.shift();

        for (var i = 0; i < paths.length; i++)
            paths[i] = 'M' + paths[i];

        return paths;
    }

    function drawPoints(pts)
    {
        for (var i = 0; i < pts.length; i++)
            ellipse(pts[i].x, pts[i].y, 2, 2);
    }


</script>
</head>
<div id="drawing"></div>


</html>
